import C from "../../shared/constants.js"
import {{name}} from '../{{name}}/index.js'
import aqp from 'api-query-params';

const allowQueryBase = ['filter','skip','limit','sort','fields','populate']
{{!-- {{#each querySettings}}
{{#if this}}
{{@key}}-{{this}}
{{/if}}
{{/each}}

{{#hasKey querySettings 'sort'}}
hasfilter
{{/hasKey}}
 --}}
// methods
///////////////////////////////////////////////////////////////////////////////
const methods = {
{{#apiEntries}}
  {{#each this as |entry|}}
    {{#if (or
      (or (eq entry.alias 'create') (eq entry.type 'create'))
      (eq @key 'create'))}}
  {{@key}}: async (req, res, next) => {
    try {
      let   body    = req.body
      let  bodyKeys = Object.keys(body)
      {{> buildAPI_authPartial entry}}
      {{> buildAPI_preAllow entry}}
      {{> buildAPI_preDeny entry}}
      {{> buildAPI_preSet entry}}

      const created = await new {{../../name}}(body).save()

      res.send(created.toObject())
    } catch(err) {
      console.log('** ERROR **: Unknown error on {{../../name}}.create', err)
      res.send({errors: {unknown: {message: 'Unknown error.'}}}, '400')
    }
  },
    {{/if}}
  {{/each}}

  {{#each this as |entry|}}
    {{#if (or
      (or (eq entry.alias 'find') (eq entry.type 'find'))
      (eq @key 'find'))}}
  {{@key}}: async (req, res, next) => {
    try {
      let  query = req.query
      let { filter,skip,limit,sort,projection,population } = aqp(query);
      {{> buildAPI_authPartial entry}}
      {{> buildAPI_preQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      {{> buildAPI_postQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      {{#if entry.filters}}
      filter = {
        ...filter,
        {{#each entry.filters}}
        {{this.field}}: {{this.value}}
        {{/each}}
      }
      {{/if}}
      const found = await {{../../name}}
        .find(filter)
        {{#buildAPI_useField ../../querySettings 'skip' entry.skip}}
        .skip(skip)
        {{/buildAPI_useField}}
        {{#buildAPI_useField ../../querySettings 'limit' entry.limit}}
        .limit(limit)
        {{/buildAPI_useField}}
        {{#buildAPI_useField ../../querySettings 'sort' entry.sort}}
        .sort(sort)
        {{/buildAPI_useField}}
        {{#buildAPI_useField ../../querySettings 'populate' entry.populate}}
        .populate(population)
        {{/buildAPI_useField}}
        {{#buildAPI_useField ../../querySettings 'fields' entry.fields}}
        .select(projection)
        {{/buildAPI_useField}}
        .lean()

      res.send(found)
    } catch(err) {
      console.log('** ERROR **: Unknown error on {{../../name}}.find', err)
      res.send({errors: {unknown: {message: 'Unknown error.'}}}, '400')
    }
  },
    {{/if}}
  {{/each}}

  {{#each this as |entry|}}
    {{#if (or
      (or (eq entry.alias 'findone') (eq entry.type 'findone'))
      (eq @key 'findone'))}}
  {{@key}}: async (req, res, next) => {
    try {
      let query     = req.query
      let queryKeys = Object.keys(query)
      let { filter,skip,limit,sort,projection,population } = aqp(query);
      {{> buildAPI_authPartial entry}}
      {{> buildAPI_preQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      {{> buildAPI_postQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      {{#if entry.filters}}
      filter = {
        ...filter,
        {{#each entry.filters}}
        {{this.field}}: {{this.value}}
        {{/each}}
      }
      {{/if}}
      const found = await {{../../name}}.findOne(filter)
                                     {{#buildAPI_useField ../../querySettings 'populate' entry.populate}}
                                     .populate(population)
                                     {{/buildAPI_useField}}
                                     {{#buildAPI_useField ../../querySettings 'fields' entry.fields}}
                                     .select(projection)
                                     {{/buildAPI_useField}}
                                     .lean()

      if (found == undefined) {
        res.send({errors: {unknown: {message: 'Not found.'}}}, '400')
      }
      res.send(found)
    } catch(err) {
      console.log('** ERROR **: Unknown error on {{../../name}}.findone', err)
      res.send({errors: {unknown: {message: 'Unknown error.'}}}, '400')
    }
  },
    {{/if}}
  {{/each}}

  {{#each this as |entry|}}
    {{#if (or
      (or (eq entry.alias 'update') (eq entry.type 'update'))
      (eq @key 'update'))}}
  {{@key}}: async (req, res, next) => {
    try {
      let   body    = req.body
      let  bodyKeys = Object.keys(body)
      let query     = req.query
      let queryKeys = Object.keys(query)
      let { filter,skip,limit,sort,projection,population } = aqp(query);
      {{> buildAPI_authPartial entry}}
      {{> buildAPI_preAllow entry}}
      {{> buildAPI_preDeny entry}}
      {{> buildAPI_preSet entry}}
      {{> buildAPI_preQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      const updated = await {{../../name}}.update(filter, body)

      res.send(updated)
    } catch(err) {
      console.log('** ERROR **: Unknown error on {{../../name}}.update', err)
      res.send({errors: {unknown: {message: 'Unknown error.'}}}, '400')
    }
  },
    {{/if}}
  {{/each}}


  {{#each this as |entry|}}
    {{#if (or
      (or (eq entry.alias 'count') (eq entry.type 'count'))
      (eq @key 'count'))}}
  {{@key}}: async (req, res, next) => {
    try {
      let  query = req.query
      let { filter,skip,limit,sort,projection,population } = aqp(query);
      {{> buildAPI_authPartial entry}}
      {{> buildAPI_preQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      {{#if entry.filters}}
      filter = {
        ...filter,
        {{#each entry.filters}}
        {{this.field}}: {{this.value}}
        {{/each}}
      }
      {{/if}}

      const count = await {{../../name}}.count(filter)

      res.send({count})
    } catch(err) {
      console.log('** ERROR **: Unknown error on {{../../name}}.count', err)
      res.send({errors: {unknown: {message: 'Unknown error.'}}}, '400')
    }
  },
    {{/if}}
  {{/each}}

  {{#each this as |entry|}}
    {{#if (or
      (or (eq entry.alias 'deleteone') (eq entry.type 'deleteone'))
      (eq @key 'deleteone'))}}
  {{@key}}: async (req, res, next) => {
    try {
      let  query = req.query
      let { filter,skip,limit,sort,projection,population } = aqp(query);
      {{> buildAPI_authPartial entry}}
      {{> buildAPI_preQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      {{#if entry.filters}}
      filter = {
        ...filter,
        {{#each entry.filters}}
        {{this.field}}: {{this.value}}
        {{/each}}
      }
      {{/if}}
      const del = await {{../../name}}.deleteOne(filter)

      res.send(del)
    } catch(err) {
      console.log('** ERROR **: Unknown error on {{../../name}}.deleteOne', err)
      res.send({errors: {unknown: {message: 'Unknown error.'}}}, '400')
    }
  },
    {{/if}}
  {{/each}}

  {{#each this as |entry|}}
    {{#if (or
      (or (eq entry.alias 'deletemany') (eq entry.type 'deletemany'))
      (eq @key 'deletemany'))}}
  {{@key}}: async (req, res, next) => {
    try {
      let  query = req.query
      let { filter,skip,limit,sort,projection,population } = aqp(query);
      {{> buildAPI_authPartial entry}}
      {{> buildAPI_preQuery settings=(buildAPI_mergeSettings ../../querySettings entry)}}
      {{#if entry.filters}}
      filter = {
        ...filter,
        {{#each entry.filters}}
        {{this.field}}: {{this.value}}
        {{/each}}
      }
      {{/if}}
      const del = await {{../../name}}.deleteMany(filter)

      res.send(del)
    } catch(err) {
      console.log('** ERROR **: Unknown error on {{../../name}}.deleteMany', err)
      res.send({errors: {unknown: {message: 'Unknown error.'}}}, '400')
    }
  },
    {{/if}}
  {{/each}}


{{/apiEntries}}
};

export default methods
